apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: update-version-in-git
spec:
  templates:
    - name: update-version-in-git
      inputs:
        parameters:
          - name: tag
      metadata:
        labels:
          app: argo
      container:
        image: alpine/git
        command: [ sh, -c ]
        args:
          - |
            cd /mnt/out \
            && ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts \
            && git clone $cloneurl || true \
            && cd {{ workflow.parameters.reponame }}-ci \
            && sed -i "s/tag: \w\{7\}/tag: {{ inputs.parameters.tag }}/g" values.yaml \
            && git config --global user.name "argo-ci" \
            && git config --global user.email "argo-ci@gepardec.com" \
            && git add . \
            && git commit -m "updated image version to tag {{ inputs.parameters.tag }}" || true \
            && git push
        volumeMounts:
          - name: workspace
            mountPath: /mnt/out/
          - name: sshkey
            mountPath: /root/.ssh/id_rsa
            subPath: id_rsa
        envFrom:
          - secretRef:
              name: "{{ workflow.parameters.reponame }}-infra"
      volumes:
        - name: sshkey
          secret:
            secretName: "{{ workflow.parameters.reponame }}-infra"
            items:
              - key: id_rsa
                path: id_rsa
                mode: 0600